on:
  workflow_dispatch:  # Allow manual triggering of the workflow

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set run details
      run: |
        run_date=$(date +'%Y-%m-%d')
        run_time=$(TZ=Asia/Kolkata date +'%I:%M %p, %Z')
        echo "run_date=$run_date" >> $GITHUB_ENV
        echo "run_time=$run_time" >> $GITHUB_ENV
      
    - name: Run JMeter script in Docker
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/jmeter \
          -w /jmeter \
          justb4/jmeter \
          -n -t Aster.jmx -l Asterresults.jtl

    - name: Install JMeter Plugins CMDRunner
      run: |
        curl -L -o CMDRunner.jar https://jmeter-plugins.org/files/cmdrunner-latest.jar

    - name: Generate Graphs
      run: |
        java -jar CMDRunner.jar --tool Reporter --generate-png response_time.png --input-jtl Asterresults.jtl --plugin-type ResponseTimesOverTime
        java -jar CMDRunner.jar --tool Reporter --generate-png throughput.png --input-jtl Asterresults.jtl --plugin-type ThroughputOverTime

    - name: Parse JTL file and prepare email content
      id: parse-results
      run: |
        # Parsing logic here...
        # Refer to your earlier parsing step for setting parsed_results and summary

    - name: Send email with parsed results and graphs
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.hostinger.com
        server_port: 465
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        subject: "Aster- Real Time Monitoring - Health Status!"
        html_body: |
          <html>
          <body style="font-family: Calibri, sans-serif;">
            <p>Please find the details of Application responsiveness:</p>
            <p>${{ env.parsed_results }}</p>
            <p><b>Response Time Graph:</b></p>
            <img src="cid:response_time.png" alt="Response Time Graph" />
            <p><b>Throughput Graph:</b></p>
            <img src="cid:throughput.png" alt="Throughput Graph" />
            <p><b>Build Information:</b></p>
            <p>Build Health Status: ${{ env.overall_status }}!<br>
            Build Date and Time: ${{ env.run_date }} & ${{ env.run_time }}</p>
            <p>Thanks,<br>QA Team.</p>
            <p>Note: This is an auto-generated email. Do not reply</p>
          </body>
          </html>
        attachments: |
          response_time.png
          throughput.png
        to: jenkins@thinktime.in
        from: ${{ secrets.USERNAME }}
        priority: normal
